<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>理解Objective-C运行时 - I make stuff</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="chen" />
  <meta name="description" content="Objective-C 运行时对于刚刚踏入 Cocoa/Objective 世界的人是很容易忽 略的 Objective-C 语言的特性之一。原因就是尽管 Objective-C 是一门几个小时之内入门的语言，但是投身 Cocoa 的新手们会花费大量时间在" />

  <meta name="keywords" content="Chen, iOS, Swift, Productivity" />






<meta name="generator" content="Hugo 0.55.0-DEV" />


<link rel="canonical" href="https://hechen.xyz/post/understanding-the-objective-c-runtime/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="理解Objective-C运行时" />
<meta property="og:description" content="Objective-C 运行时对于刚刚踏入 Cocoa/Objective 世界的人是很容易忽 略的 Objective-C 语言的特性之一。原因就是尽管 Objective-C 是一门几个小时之内入门的语言，但是投身 Cocoa 的新手们会花费大量时间在" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hechen.xyz/post/understanding-the-objective-c-runtime/" />
<meta property="article:published_time" content="2015-09-07T17:55:33&#43;00:00"/>
<meta property="article:modified_time" content="2015-09-07T17:55:33&#43;00:00"/>

<meta itemprop="name" content="理解Objective-C运行时">
<meta itemprop="description" content="Objective-C 运行时对于刚刚踏入 Cocoa/Objective 世界的人是很容易忽 略的 Objective-C 语言的特性之一。原因就是尽管 Objective-C 是一门几个小时之内入门的语言，但是投身 Cocoa 的新手们会花费大量时间在">


<meta itemprop="datePublished" content="2015-09-07T17:55:33&#43;00:00" />
<meta itemprop="dateModified" content="2015-09-07T17:55:33&#43;00:00" />
<meta itemprop="wordCount" content="9160">



<meta itemprop="keywords" content="iOS,Objective-C,Runtime," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="理解Objective-C运行时"/>
<meta name="twitter:description" content="Objective-C 运行时对于刚刚踏入 Cocoa/Objective 世界的人是很容易忽 略的 Objective-C 语言的特性之一。原因就是尽管 Objective-C 是一门几个小时之内入门的语言，但是投身 Cocoa 的新手们会花费大量时间在"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Chen</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Chen
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">理解Objective-C运行时</h1>
      
      <div class="post-meta">
        <time datetime="2015-09-07" class="post-time">
          2015-09-07
        </time>
        <div class="post-category">
            <a href="https://hechen.xyz/categories/translation/"> Translation </a>
            
          </div>
        

        
        

        
        
          <span id="/post/understanding-the-objective-c-runtime/" class="leancloud_visitors" data-flag-title="理解Objective-C运行时">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#objective-c运行时是开源的">Objective-C运行时是开源的</a></li>
<li><a href="#动态-vs-静态">动态 Vs. 静态</a></li>
<li><a href="#什么是-objective-c-运行时">什么是 Objective-C 运行时？</a></li>
<li><a href="#objective-c-运行时术语">Objective-C 运行时术语</a></li>
<li><a href="#因此类定义了对象而不是对象本身-那这又是如何实现的">因此类定义了对象而不是对象本身，那这又是如何实现的？</a></li>
<li><a href="#为什么我们都要继承自apple的类呢">为什么我们都要继承自Apple的类呢？</a></li>
<li><a href="#类缓存-objc-cache-cache-是什么">类缓存（objc_cache* cache）是什么？</a></li>
<li><a href="#那-objc-msgsend-方法都发生了什么呢">那 objc_msgSend 方法都发生了什么呢？</a></li>
<li><a href="#objective-c-消息转发">Objective-C 消息转发</a></li>
<li><a href="#non-fragile-ivars-modern-runtime">Non Fragile ivars (Modern Runtime)</a></li>
<li><a href="#objective-c-关联对象">Objective-C 关联对象</a></li>
<li><a href="#混合的虚表派生">混合的虚表派生</a></li>
<li><a href="#因此你如何能知道你正在和它打交道呢">因此你如何能知道你正在和它打交道呢？</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#参考链接">参考链接</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>Objective-C 运行时对于刚刚踏入 Cocoa/Objective 世界的人是很容易忽
略的 Objective-C 语言的特性之一。原因就是尽管 Objective-C 是一门几个小时之内入门的语言，但是投身 Cocoa 的新手们会花费大量时间在 Cocoa 框架中，试图搞清楚他到底是怎么工作的。<!-- more --> 我觉得每个开发者都应该对其有深入的了解，明白一些内部的实现细节，而不仅仅只知道代码 <code>[target doMethodWith:var]</code> 会被编译器转换成 <code>objc_msgSend(target,@selector(doMethodWith:),var1);</code> 而已。了解 Objective-C 运行时的原理有助于你对 Objective-C 语言有更深入的理解，清楚你得 App 是怎么运行的。我觉得这对无论是 Mac/iPhone 新手或者老手都会有所帮助。</p>

<p>[TOC]</p>

<h4 id="objective-c运行时是开源的">Objective-C运行时是开源的</h4>

<p>Objective-C 运行时是开源的，你可以随时从 <a href="http://opensource.apple.com">Apple</a> 获取到。实际上查看 Objective-C 运行时源码是我搞清楚这个语言是怎么运作的首选方法，而不是去查看和它相关的苹果文档。你可以到<a href="http://opensource.apple.com/tarballs/objc4/objc4-437.1.tar.gz">这里</a> 下载到运行时的源码（截止到译者翻译的时候，最新版本的文件是objc4-647.tar.gz）。</p>

<h4 id="动态-vs-静态">动态 Vs. 静态</h4>

<p>Objective-C 是一门动态的面向对象语言，这意味着它可以将编译链接时决定的事情推迟到运行时进行。这就给了你很大的灵活性，你可以按照自己的需要重定向消息到适当的对象上，你甚至可以交换方法实现（译者注：method swizzling，方法调配，开发者常用此技术向原有实现中添加新功能）。而运行时可以使对象明白自己可以响应哪些消息，不能响应哪些消息（译者注：introspect 内省），并正确的派发消息。</p>

<blockquote>
<p>译者注： 内省（introspection）是面向对象语言和环境的一个强大特性，Objective-C和Cocoa在这个方面尤其的丰富。内省是对象揭示自己作为一个运行时对象的详细信息的一种能力。这些详细信息包括对象在继承树上的位置，对象是否遵循特定的协议，以及是否可以响应特定的消息。NSObject协议和类定义了很多内省方法，用于查询运行时信息，以便根据对象的特征进行识别。</p>

<p>参考: <a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/CocoaEncyclopedia/Introspection/Introspection.html">Objective-C 的 Introspection</a></p>
</blockquote>

<p>我们将这些特征和C语言进行对比来看，在C中，你从<code>main()</code>函数开始，然后按顺序从上往下写你的代码逻辑或者执行函数方法。C结构体是无法将请求转发到其他目标对象来执行方法的。你很可能写了如下类似的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cp">#include</span> <span class="cpf">&lt; stdio.h &gt;</span><span class="cp">
</span><span class="cp"></span> 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello World!&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>编译器解析、优化然后将优化后的代码转换成如下的汇编语言：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">.</span><span class="n">text</span>
 <span class="p">.</span><span class="n">align</span> <span class="mi">4</span><span class="p">,</span><span class="mh">0x90</span>
 <span class="p">.</span><span class="n">globl</span> <span class="n">_main</span>
<span class="nl">_main</span><span class="p">:</span>
<span class="nl">Leh_func_begin1</span><span class="p">:</span>
 <span class="n">pushq</span> <span class="o">%</span><span class="n">rbp</span>
<span class="nl">Llabel1</span><span class="p">:</span>
 <span class="n">movq</span> <span class="o">%</span><span class="n">rsp</span><span class="p">,</span> <span class="o">%</span><span class="n">rbp</span>
<span class="nl">Llabel2</span><span class="p">:</span>
 <span class="n">subq</span> <span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="o">%</span><span class="n">rsp</span>
<span class="nl">Llabel3</span><span class="p">:</span>
 <span class="n">movq</span> <span class="o">%</span><span class="n">rsi</span><span class="p">,</span> <span class="o">%</span><span class="n">rax</span>
 <span class="n">movl</span> <span class="o">%</span><span class="n">edi</span><span class="p">,</span> <span class="o">%</span><span class="n">ecx</span>
 <span class="n">movl</span> <span class="o">%</span><span class="n">ecx</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
 <span class="n">movq</span> <span class="o">%</span><span class="n">rax</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
 <span class="n">xorb</span> <span class="o">%</span><span class="n">al</span><span class="p">,</span> <span class="o">%</span><span class="n">al</span>
 <span class="n">leaq</span> <span class="n">LC</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span> <span class="o">%</span><span class="n">rcx</span>
 <span class="n">movq</span> <span class="o">%</span><span class="n">rcx</span><span class="p">,</span> <span class="o">%</span><span class="n">rdi</span>
 <span class="n">call</span> <span class="n">_printf</span>
 <span class="n">movl</span> <span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">)</span>
 <span class="n">movl</span> <span class="o">-</span><span class="mi">4</span><span class="p">(</span><span class="o">%</span><span class="n">rbp</span><span class="p">),</span> <span class="o">%</span><span class="n">eax</span>
 <span class="n">addq</span> <span class="err">$</span><span class="mi">16</span><span class="p">,</span> <span class="o">%</span><span class="n">rsp</span>
 <span class="n">popq</span> <span class="o">%</span><span class="n">rbp</span>
 <span class="n">ret</span>
<span class="nl">Leh_func_end1</span><span class="p">:</span>
 <span class="p">.</span><span class="n">cstring</span>
<span class="nl">LC</span><span class="p">:</span>
 <span class="p">.</span><span class="n">asciz</span> <span class="s">&#34;Hello World!&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>然后将其和C库链接生成可执行文件。相比之下，Objective-C语言整个过程和上面类似，不过代码的产生依赖Objective-C运行时的具体表现（译者注：运行时按照不同情况，生成不同的代码吧）。当我们刚接触Objective-C语言的时候，我们可能被告知像如下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="nb">self</span> <span class="nl">doSomethingWithVar</span><span class="p">:</span><span class="n">var1</span><span class="p">];</span></code></pre></td></tr></table>
</div>
</div>
<p>会被转换成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">objc_msgSend</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">doSomethingWithVar</span><span class="p">:),</span><span class="n">var1</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
<p>而除了这些，我们似乎就不清楚运行时还干了什么。</p>

<h4 id="什么是-objective-c-运行时">什么是 Objective-C 运行时？</h4>

<p>Objective-C Runtime 是一个运行时库，主要是由C语言和汇编语言写成，为 C 语言添加面向对象的能力而创造了 Objective-C（译者注：正是 OC Runtime，才有 OC 这门语言）。这意味着它可以加载类信息，进行方法派发以及方法转发等等。Objective-C 运行时最重要的就是为Objective-C语言的面向对象特性的实现提供了所有的基础支撑。</p>

<h4 id="objective-c-运行时术语">Objective-C 运行时术语</h4>

<p>在我们进一步了解整个运行时之前，需要先了解一些接下来出现的术语。截至目前Mac和iPhone的开发者关心的有两个运行时：Modern Runtime &amp; Legacy Runtime 。前者覆盖所有64位Mac OS X 的app和所有的iOS app，后者覆盖其余的（全部的Mac OS X 32位 App）。关于方法，这里有两种基本类型的方法，一种是实例方法（&rsquo;-&lsquo;开头， 例如<code>-(void)doFoo</code>，作用于对象实例），另一种是类方法（&rsquo;+&lsquo;开头，例如<code>+(id)alloc</code>）。方法就像C语言中的函数类似，一段代码完成一个小的任务，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">movieTitle</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">@&#34;Futurama: Into the Wild Green Yonder&#34;</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><strong>Selector</strong><br />
Objective-C中的Selector（选择子）是一个重要的C数据结构，用以标识你要一个对象执行的Objective-C方法。在运行时中，Selector的定义应该和下面这样类似：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_selector</span>  <span class="o">*</span><span class="kt">SEL</span><span class="p">;</span> </code></pre></td></tr></table>
</div>
</div>
<p>用法就像下面这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">SEL</span> <span class="n">aSel</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">movieTitle</span><span class="p">);</span> </code></pre></td></tr></table>
</div>
</div>
<p><strong>Message</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="n">target</span> <span class="nl">getMovieTitleForObject</span><span class="p">:</span><span class="n">obj</span><span class="p">];</span></code></pre></td></tr></table>
</div>
</div>
<p>Objective-C中的方法由两个方括号[]组成，括号中间是你将要将消息发往的目标对象和你将要该对象执行的方法以及所需要发送的参数列表。Objective-C中的消息和C函数类似，但是又不同。你向一个对象发送消息并不意味着该对象就一定会执行它。这个对象会检查该消息的发送者，然后基于该发送者要么执行一个不同的方法或者将该消息转发给另外的不同的对象。</p>

<p><strong>Class</strong>
如果你看过Runtime中关于类的定义信息，你可能会遇到这样的定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_class</span> <span class="o">*</span><span class="kt">Class</span><span class="p">;</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_object</span> <span class="p">{</span>
    <span class="kt">Class</span> <span class="n">isa</span><span class="p">;</span>
<span class="p">}</span> <span class="o">*</span><span class="kt">id</span><span class="p">;</span> </code></pre></td></tr></table>
</div>
</div>
<p>这其中有一些事情要注意。
每一个Objective-C类拥有一个结构体，每一个对象也有一个结构体。所有的对象都包含一个isa指针。所有的Objective-C运行时需要这个isa指针，用以检查一个对象具体的类型是什么，然后判别其是否能够响应你所派发过来的消息。
最后我们还注意到了id指针，这个id指针仅仅告诉我们其指向的是Objective-C对象，仅此而已。当你拥有一个id指针，你可以查询该对象的类型，然后查看该类型是否可以响应某个方法等等。还有就是当你知道了当前所指向的具体对象的具体类别，你就可以做出更具体的动作。</p>

<p><strong>Blocks</strong></p>

<p>你也可以在LLVM/Clang文档中对Blocks 的定义中发现和上面类似的东西。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">struct</span> <span class="n">Block_literal_1</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">isa</span><span class="p">;</span> <span class="c1">// initialized to &amp;_NSConcreteStackBlock or &amp;_NSConcreteGlobalBlock
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">reserved</span><span class="p">;</span> 
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">invoke</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
    <span class="k">struct</span> <span class="n">Block_descriptor_1</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">reserved</span><span class="p">;</span> <span class="c1">// NULL
</span><span class="c1"></span>         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>  <span class="c1">// sizeof(struct Block_literal_1)
</span><span class="c1"></span>         <span class="c1">// optional helper functions
</span><span class="c1"></span>         <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">copy_helper</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
         <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">dispose_helper</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span> 
    <span class="p">}</span> <span class="o">*</span><span class="n">descriptor</span><span class="p">;</span>
    <span class="c1">// imported variables
</span><span class="c1"></span><span class="p">};</span> </code></pre></td></tr></table>
</div>
</div>
<p>Blocks被设计成能够与Objective-C运行时兼容，因此它们可以被当做对象处理，并可以响应消息（像<code>-retain</code>, <code>-release</code>, <code>-copy</code>等）。</p>

<p><strong>IMP</strong>（Method Implementations）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="nf">id</span> <span class="p">(</span><span class="o">*</span><span class="kt">IMP</span><span class="p">)(</span><span class="kt">id</span> <span class="nb">self</span><span class="p">,</span><span class="kt">SEL</span> <span class="n">_cmd</span><span class="p">,...);</span> </code></pre></td></tr></table>
</div>
</div>
<p>IMP是编译器生成的函数指针，指向方法执行处。如果你刚接触Objective-C语言，你不需要直接和这些东西打交道，但是慢慢深入之后接触的就多了。后面我们会看到这也是Objective-C运行时唤醒方法的方式。</p>

<p><strong>Objective-C Classes</strong></p>

<p>Objective-C 的类内部有些什么东西呢？一个Objective-C的类的样子大体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">MyClass</span> : <span class="nc">NSObject</span> <span class="p">{</span>
    <span class="c1">// vars
</span><span class="c1"></span>    <span class="n">NSInteger</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// methods
</span><span class="c1"></span><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doFoo</span><span class="p">;</span>
<span class="k">@end</span></code></pre></td></tr></table>
</div>
</div>
<p>但是运行时还会追加更多的内容以便跟踪（类每一时刻的状态）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cp">#if !__OBJC2__
</span><span class="cp"></span>    <span class="kt">Class</span> <span class="n">super_class</span>                                        <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span>                                         <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">version</span>                                             <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">info</span>                                                <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">instance_size</span>                                       <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_ivar_list</span> <span class="o">*</span><span class="n">ivars</span>                             <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_method_list</span> <span class="o">**</span><span class="n">methodLists</span>                    <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_cache</span> <span class="o">*</span><span class="n">cache</span>                                 <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">objc_protocol_list</span> <span class="o">*</span><span class="n">protocols</span>                     <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span>
<span class="cp">#endif </span></code></pre></td></tr></table>
</div>
</div>
<p>我们可以看到一个类中包含一个指向其父类的引用，该类的名字、实例变量、方法集合、缓存以及该类遵循的协议列表。运行时需要这些信息以便响应那些分发到该类或者类实例对象上得方法。</p>

<h4 id="因此类定义了对象而不是对象本身-那这又是如何实现的">因此类定义了对象而不是对象本身，那这又是如何实现的？</h4>

<p>正如我前面说过的，Objective-C类本身也同样是对象（译者注：意味着你可以向一个类发送消息），运行时通过创建元类来处理它们。当你发送类似<code>[NSObject alloc]</code>的消息时，你实际上是向类对象发送了消息，而这个类对象需要是<strong>元类</strong>的实例，而元类本身又是<strong>根元类</strong>的一个实例。
当你说一个类继承自NSObject，那就意味着你的类指向NSObject作为其父类。而所有的元类指向根元类作为它们的父类，所有的元类都仅包含那些它能够响应的消息中的类方法。所以当你向一个类对象发送消息，例如<code>[NSObject alloc]</code>的时候，<code>objc_msgSend()</code>实际上会查看元类来确定该对象是否能够响应该消息，那如果找到了一个能响应该消息的方法，就在该对象上执行它。</p>

<blockquote>
<p>译者注：Objective-C类体系结构图如下所示：<img src="https://i.imgur.com/D7GUGKB.png" alt="ios-runtime-class" /></p>
</blockquote>

<h4 id="为什么我们都要继承自apple的类呢">为什么我们都要继承自Apple的类呢？</h4>

<p>当你刚踏入Cocoa开发的时候，很多代码例子都告诉你这样做：先继承NSObject类然后再进行其他编码。你也乐在其中，确实享受到了很多继承自Apple类所提供的便利。但是你甚至可能都没有发现实际上你的类在和Objective-C运行时打交道。当你为我们的类实例化的时候，像这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">MyObject</span> <span class="o">*</span><span class="n">object</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span></code></pre></td></tr></table>
</div>
</div>
<p>第一个你要执行的消息就是<code>+alloc</code>。如果你[查看文档][6]，里面会讲到“一个新生实例的isa实例会被初始化为一个描述该类信息的数据结构，其余的实例变量的内存均被设置为空。”所以通过继承自Apple的类，我们不仅继承了一些很棒的属性，同时也继承了这些在内存上分配空间（大小是我们类的大小），创建对象的能力（就是创建运行时所期望的带有isa指针的数据结构）。</p>

<h4 id="类缓存-objc-cache-cache-是什么">类缓存（objc_cache* cache）是什么？</h4>

<p>当Objective-C运行时通过一个对象的isa指针检查对象的时候，它会找到能够执行很多方法的类。然后你只需要调用其中很小一部分，所以每次运行时在进行一次查询动作时需要查找类分发表中所有的selectors这个动作是毫无意义的。这就是为什么类会由cache这个东西，当你查询一个类体系中的派发表的时候，一旦找到对应的selector时，就将该selector放到cache中。当<code>objc_msgSend()</code>方法在一个类中查询selector时，会先在cache中查找，这个理论的基础就是如果你曾经调用过一个类的消息，你有很大可能在之后还调用同样的方法。（译者注：CACHE的局部性原理）。所以按照这样考虑，如果我们先在有一个NSObject的子类MyObject如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">MyObject</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
 
<span class="k">@implementation</span> <span class="nc">MyObject</span>
<span class="p">-(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">setVarA</span><span class="p">:@</span><span class="err">”</span><span class="n">blah</span><span class="err">”</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span></code></pre></td></tr></table>
</div>
</div>
<p>具体发生了以下几点：
1. <code>[MyObject alloc]</code>首先被执行，MyObject类没有实现该方法，因此在该类中没有找到<code>+alloc</code>方法，接着顺着superclass指针找到其父类<code>NSObject</code>；
2. 我们询问<code>NSObject</code>类是否能够响应<code>+alloc</code>方法，而它能够响应。<code>+alloc</code>方法检查接受者类（也就是<code>MyObject</code>），分配该类大小的一块内存空间，然后初始化其isa指针指向<code>MyObject</code>类，此时我们拥有一个实例了，同时稍早我们将<code>+alloc</code>方法放置于<code>NSObject</code>的类缓存（cache）中；
3. 到目前为止，我们都是在发送类方法，此刻我们需要向一个实例对象发送消息，这里简单的调用<code>-init</code>方法或者指定初始化方法（designated initializer），当然我们的类实现了该方法，因此我们将<code>-(id)init</code>方法放置于cache中；
4. 接下来<code>self = [super init]</code>被调用，<code>super</code>是一个神奇的关键字（<strong>magic keyword</strong>），其指向类的父类，也即<code>NSObject</code>，我们调用<code>NSObject</code>的<code>init</code>方法。这样做的目的是为了确保面向对象编程的集成体系能够正确运行，在你正确初始化自身变量之前需要先初始化该类的所有父类的变量，如果你需要，你还可以覆写父类的方法。在该例中，对于NSObject类来说并没有多少特别重要的操作要进行，不过这并不是常态。有时候初始化中会做非常重要的事情，考虑以下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cp">#import &lt; Foundation/Foundation.h&gt;
</span><span class="cp"></span> 
<span class="k">@interface</span> <span class="nc">MyObject</span> : <span class="nc">NSObject</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">aString</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">@property</span><span class="p">(</span><span class="k">retain</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">aString</span><span class="p">;</span>
 
<span class="k">@end</span>
 
<span class="k">@implementation</span> <span class="nc">MyObject</span>
 
<span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">init</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
      <span class="p">[</span><span class="nb">self</span> <span class="nl">setAString</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">@synthesize</span> <span class="n">aString</span><span class="p">;</span>
 
<span class="k">@end</span>

 
<span class="kt">int</span> <span class="n">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">NSAutoreleasePool</span> <span class="o">*</span> <span class="n">pool</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSAutoreleasePool</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
 
    <span class="kt">id</span> <span class="n">obj1</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="n">alloc</span><span class="p">];</span>
    <span class="kt">id</span> <span class="n">obj2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
 
    <span class="kt">id</span> <span class="n">obj3</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSArray</span> <span class="n">alloc</span><span class="p">];</span>
    <span class="kt">id</span> <span class="n">obj4</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithObjects</span><span class="p">:</span><span class="s">@&#34;Hello&#34;</span><span class="p">,</span><span class="nb">nil</span><span class="p">];</span>
      
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;obj1 class is %@&#34;</span><span class="p">,</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">obj1</span> <span class="k">class</span><span class="p">]));</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;obj2 class is %@&#34;</span><span class="p">,</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">obj2</span> <span class="k">class</span><span class="p">]));</span>
  
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;obj3 class is %@&#34;</span><span class="p">,</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">obj3</span> <span class="k">class</span><span class="p">]));</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;obj4 class is %@&#34;</span><span class="p">,</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">obj4</span> <span class="k">class</span><span class="p">]));</span>
  
    <span class="kt">id</span> <span class="n">obj5</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyObject</span> <span class="n">alloc</span><span class="p">];</span>
    <span class="kt">id</span> <span class="n">obj6</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MyObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
  
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;obj5 class is %@&#34;</span><span class="p">,</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">obj5</span> <span class="k">class</span><span class="p">]));</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;obj6 class is %@&#34;</span><span class="p">,</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">obj6</span> <span class="k">class</span><span class="p">]));</span>
          
    <span class="p">[</span><span class="n">pool</span> <span class="n">drain</span><span class="p">];</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如果你是刚刚接触Cocoa，我让你猜以上代码打印结果是什么，你很可能会给出这样的结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">NSMutableArray</span>
<span class="n">NSMutableArray</span> 
<span class="n">NSArray</span>
<span class="n">NSArray</span>
<span class="n">MyObject</span>
<span class="n">MyObject</span></code></pre></td></tr></table>
</div>
</div>
<p>但实际上是如下结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">obj1</span> <span class="k">class</span> <span class="n">is</span> <span class="n">__NSPlaceholderArray</span>
<span class="n">obj2</span> <span class="k">class</span> <span class="n">is</span> <span class="n">NSCFArray</span>
<span class="n">obj3</span> <span class="k">class</span> <span class="n">is</span> <span class="n">__NSPlaceholderArray</span>
<span class="n">obj4</span> <span class="k">class</span> <span class="n">is</span> <span class="n">NSCFArray</span>
<span class="n">obj5</span> <span class="k">class</span> <span class="n">is</span> <span class="n">MyObject</span>
<span class="n">obj6</span> <span class="k">class</span> <span class="n">is</span> <span class="n">MyObject</span></code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>译者注：（本机XCode 7 beta6 运行结果如下：）</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mi">13</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">06.922</span> <span class="n">ObjMessage</span><span class="p">[</span><span class="mi">5185</span><span class="o">:</span><span class="mi">1441448</span><span class="p">]</span> <span class="n">obj1</span> <span class="k">class</span> <span class="n">is</span> <span class="n">__NSPlaceholderArray</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mi">13</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">11.201</span> <span class="n">ObjMessage</span><span class="p">[</span><span class="mi">5185</span><span class="o">:</span><span class="mi">1441448</span><span class="p">]</span> <span class="n">obj2</span> <span class="k">class</span> <span class="n">is</span> <span class="n">__NSArrayM</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mi">13</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">17.987</span> <span class="n">ObjMessage</span><span class="p">[</span><span class="mi">5185</span><span class="o">:</span><span class="mi">1441448</span><span class="p">]</span> <span class="n">obj3</span> <span class="k">class</span> <span class="n">is</span> <span class="n">__NSPlaceholderArray</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mi">13</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">18.503</span> <span class="n">ObjMessage</span><span class="p">[</span><span class="mi">5185</span><span class="o">:</span><span class="mi">1441448</span><span class="p">]</span> <span class="n">obj4</span> <span class="k">class</span> <span class="n">is</span> <span class="n">__NSArrayI</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mi">13</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">32.228</span> <span class="n">ObjMessage</span><span class="p">[</span><span class="mi">5185</span><span class="o">:</span><span class="mi">1441448</span><span class="p">]</span> <span class="n">obj5</span> <span class="k">class</span> <span class="n">is</span> <span class="n">MyObject</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mi">13</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mf">33.478</span> <span class="n">ObjMessage</span><span class="p">[</span><span class="mi">5185</span><span class="o">:</span><span class="mi">1441448</span><span class="p">]</span> <span class="n">obj6</span> <span class="k">class</span> <span class="n">is</span> <span class="n">MyObject</span></code></pre></td></tr></table>
</div>
</div>
<p>原因就是Objective-C语言这里使用<code>+alloc</code>方法返回某个类的对象，但随后<code>-init</code>方法又可能返回另一个类的对象。</p>

<h4 id="那-objc-msgsend-方法都发生了什么呢">那 objc_msgSend 方法都发生了什么呢？</h4>

<p>实际上<code>objc_msgSend()</code>方法内部发生了许多事情。如下我们有这样的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">[</span><span class="nb">self</span> <span class="nl">printMessageWithString</span><span class="p">:</span><span class="s">@&#34;Hello World!&#34;</span><span class="p">];</span></code></pre></td></tr></table>
</div>
</div>
<p>编译器会把其翻译成如下所示代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="n">objc_msgSend</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">printMessageWithString</span><span class="p">:),</span> <span class="s">@&#34;Hello World!&#34;</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
<p>我们通过目标对象的isa指针来查询该类或者其继承体系中的父类是否能够响应 <code>@selector(printMessageWithString:)</code>。假设我们在类的派发表或者它的cache中找到了该selector，然后我们通过该函数指针来执行该方法。因此我们可以了解<code>objc_msgSend()</code>方法永远不会返回，它从执行开始，通过指针查找到你的方法执行，然后是你的方法执行之后返回，因此看起来好像<code>objc_msgSend()</code>方法返回似的。Bill Bumgarner对此过程有更多的细节探索（<a href="http://www.friday.com/bbum/2009/12/18/objc_msgsend-part-1-the-road-map">Part 1</a>, <a href="http://www.friday.com/bbum/2009/12/18/objc_msgsend-tour-part-3-the-fast-path">Part 2</a> &amp; <a href="http://www.friday.com/bbum/2009/12/18/objc_msgsend-tour-part-2-setting-the-stage">Part 3</a>）。</p>

<p>我这里总结下他所讲的，也就是你会在运行时代码中看到的：
1. 检查那些忽略掉的Selectors和Short Circut， 很明显如果我们运行在垃圾回收环境下，我们可以忽略掉针对<code>-retain</code>，<code>-release</code>等的调用；</p>

<ol>
<li><p>检查那些nil的目标。不像其他语言，Objective-C中向nil派发消息是合法的。当然你肯定也有很多理由希望这样。这里假设我们有一个非空的目标；</p></li>

<li><p>接下来我们需要在该类中找到IMP，我们首先查找该类的缓存（cache），如果找到我们便通过缓存中的指针跳转到该函数执行处；</p></li>

<li><p>如果缓存中没有找到该IMP，我们便紧接着查找类的派发表（dispatch table），如果找到同样跳转到函数执行处；</p></li>

<li><p>如果类的派发表中也未找到我们就需要触发消息分发机制了，这意味着最终你得代码会被编译器转换成了C函数。因此一个如下方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-(</span><span class="kt">int</span><span class="p">)</span><span class="nf">doComputeWithNum:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">aNum</span> </code></pre></td></tr></table>
</div>
</div></li>
</ol>

<p>会被转换成如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">int</span> <span class="n">aClass_doComputeWithNum</span><span class="p">(</span><span class="n">aClass</span> <span class="o">*</span><span class="nb">self</span><span class="p">,</span><span class="kt">SEL</span> <span class="n">_cmd</span><span class="p">,</span><span class="kt">int</span> <span class="n">aNum</span><span class="p">)</span> </code></pre></td></tr></table>
</div>
</div>
<p>Objective-C运行时通过触发指向这些方法的函数指针来调用你的方法。告诉你，你没法直接调用这些转换之后的方法，尽管Cocoa框架确实提供了能够获取这些指针的方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">//declare C function pointer
</span><span class="c1"></span><span class="kt">int</span> <span class="p">(</span><span class="n">computeNum</span> <span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span><span class="kt">SEL</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
 
<span class="c1">//methodForSelector is COCOA &amp; not ObjC Runtime
</span><span class="c1">//gets the same function pointer objc_msgSend gets
</span><span class="c1"></span><span class="n">computeNum</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">id</span><span class="p">,</span><span class="kt">SEL</span><span class="p">,</span><span class="kt">int</span><span class="p">))[</span><span class="n">target</span> <span class="nl">methodForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">doComputeWithNum</span><span class="p">:)];</span>
 
<span class="c1">//execute the C function pointer returned by the runtime
</span><span class="c1"></span><span class="n">computeNum</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">doComputeWithNum</span><span class="p">:),</span><span class="n">aNum</span><span class="p">);</span> </code></pre></td></tr></table>
</div>
</div>
<p>通过这个方法，你可以获取到在运行时直接获取该方法并调用它。甚至在你确认一个指定的方法需要被执行的时候可以绕过运行时机制。这也是Objective-C运行时如何调用你的方法的，但还是使用<code>objc_msgSend()</code>方法为好。</p>

<h4 id="objective-c-消息转发">Objective-C 消息转发</h4>

<p>在Objective-C中，向一个根本不知道怎么响应方法的对象发送方法是合法的（也可能是该语言内部设计哲理）。Apple这样做的其中一个原因就是模拟Objective-C语言原生不支持的多重继承。或者你也许想抽象化自己的设计，隐藏该消息响应背后的其他类或者对象。这对于运行时系统也是非常必要的。它的工作流程大体是这样：</p>

<ol>
<li><p>运行时在该类或者其继承体系中的缓存中和派发表中查找，然后查找失败；</p></li>

<li><p>Objective-C运行时在所属对象的类上调用<code>+ (BOOL) resolveInstanceMethod:(SEL)aSEL</code>类方法，该类给予你一次机会来新增一个处理选择子<code>aSEL</code>的方法，然后告诉运行时你已经解决了该方法，消息转发机制会找到该方法。</p></li>
</ol>

<p>如下示例，你定义了一个函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="kt">void</span> <span class="nf">fooMethod</span><span class="p">(</span><span class="kt">id</span> <span class="n">obj</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">_cmd</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&#34;Doing Foo&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>你可以使用<code>class_addMethod()</code>方法类解决它：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">+(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">resolveInstanceMethod:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSEL</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">aSEL</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">doFoo</span><span class="p">:))</span> <span class="p">{</span>
        <span class="n">class_addMethod</span><span class="p">([</span><span class="nb">self</span> <span class="k">class</span><span class="p">],</span><span class="n">aSEL</span><span class="p">,(</span><span class="kt">IMP</span><span class="p">)</span><span class="n">fooMethod</span><span class="p">,</span><span class="s">&#34;v@:&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="n">resolveInstanceMethod</span><span class="p">];</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>其中方法<code>class_addMethod()</code>中的<code>v@:</code>标明了方法的返回类型以及其参数类型。你可以在运行时文档中[Type Encodings][10]分查看到详细的说明。</p>

<ol>
<li><p>如果2中<code>+(BOOL)resolveInstanceMethod:(SEL)aSEL</code>返回NO表示无法解析该方法的话，运行时接着调用<code>- (id)forwardingTargetForSelector:(SEL) aSelector</code>来给你再一次机会是否能够将该消息转发给其他接收者来处理。这要比之后运行完整的消息转发<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>要好。你可以这样执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">forwardingTargetForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="n">aSelector</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">mysteriousMethod</span><span class="p">:))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">alternateObject</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">return</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">forwardingTargetForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol>

<p>很明显，你肯定不想返回 self，否则会引起死循环。</p>

<ol>
<li><p>如果上一步没有找到合适的目标对象来执行上面的消息，接着运行时会尝试最后一步 <code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>。你可能没见过NSInvocation，它实际上是Objective-C语言中的消息类型。一旦你有一个NSInvocation，你基本上能够改变这个消息的任何东西，包括其目标、选择子以及参数。所以你可以这样做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="n">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span> <span class="p">{</span>
<span class="kt">SEL</span> <span class="n">invSEL</span> <span class="o">=</span> <span class="n">invocation</span><span class="p">.</span><span class="n">selector</span><span class="p">;</span>
 
<span class="k">if</span><span class="p">([</span><span class="n">altObject</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">invSEL</span><span class="p">])</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">invocation</span> <span class="nl">invokeWithTarget</span><span class="p">:</span><span class="n">altObject</span><span class="p">];</span>
<span class="p">}</span> 
<span class="k">else</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">doesNotRecognizeSelector</span><span class="p">:</span><span class="n">invSEL</span><span class="p">];</span>
<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div></li>
</ol>

<p>默认情况下，如果你继承自NSObject类，它所实现的<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>内部仅仅简单的调用了<code>-doesNotRecognizeSelector:</code>方法，如果你想给自己最后一次机会做一些事情的话，你可以重载该方法。</p>

<h4 id="non-fragile-ivars-modern-runtime">Non Fragile ivars (Modern Runtime)</h4>

<p>一个Modern Runtime新增加的概念就是Non Fragile ivars。当编译器编译我们的类时，编译器会生成一个变量布局来显示每次我们从什么位置去取我们的实例变量，其底层的实现细节是这样的，查看类成员变量和类对象指针指向位置的偏移，读取该变量大小的字节就可以将该变量读取出来。所以你得变量布局可能如下所示，左侧列标明字节偏移量：</p>

<p><img src="https://i.imgur.com/35waSjN.png" alt="NSObject 布局" /></p>

<p>这里我们有NSObject类型的变量布局，然后我们继承NSObject来扩展它，并添加自己的变量，这在Apple发布新版本OSX SDK之前都运行良好。</p>

<p><img src="https://i.imgur.com/xPo1FAw.png" alt="NSObject 布局" /></p>

<p>我们的代码就无法正常运行，我们自定义对象中的内容被擦出了，因为NSObject增加了两个成员变量，而MyObject类成员变量布局在编译时已经确定，有两个成员变量和基类的内存区域重叠。唯一能够阻止这个发生的就是Apple维持它之前的布局策略，但是一旦这样他们的框架就无法再往前发展了，因为它们的变量布局已经固化了。在这种情况下（也就是fragile ivars）你只能通过重新编译这些继承自Apple类的类来使得代码得以兼容。那在 non fragile ivars下会发生什么呢？</p>

<p><img src="https://i.imgur.com/w9Fxvpa.png" alt="NSObject 布局" /></p>

<p>在Non Fragile ivars下编译器虽然生成了和fragile ivars同样的布局，但是运行时会通过计算基类大小，动态调整MyObject类成员布局。结果如上图所示。</p>

<h4 id="objective-c-关联对象">Objective-C 关联对象</h4>

<p>最近引入Mac OS X 10.6系统有一个特性称作“关联引用”。Objective-C不像其他语言，其原生不支持向对象动态添加变量。所以到目前为止，你都必须要费很大的劲，编译整个体系结构来假装自己向类中添加一个变量。不过在Mac OS X 10.6系统中，Objective-C 运行时原生支持（动态添加变量）。如果我们想向每一个已经存在的类中添加一个变量，例如向NSView类中添加，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cp">#import &lt; Cocoa/Cocoa.h&gt; </span><span class="c1">//Cocoa
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt; objc/runtime.h&gt; //objc runtime api’s</span><span class="cp">
</span><span class="cp"></span> 
<span class="k">@interface</span> <span class="nc">NSView</span> <span class="nl">(CustomAdditions)</span>
<span class="k">@property</span><span class="p">(</span><span class="k">retain</span><span class="p">)</span> <span class="n">NSImage</span> <span class="o">*</span><span class="n">customImage</span><span class="p">;</span>
<span class="k">@end</span>
 
<span class="k">@implementation</span> <span class="nc">NSView</span> <span class="nl">(CustomAdditions)</span>
 
<span class="k">static</span> <span class="kt">char</span> <span class="n">img_key</span><span class="p">;</span> <span class="c1">//has a unique address (identifier)
</span><span class="c1"></span> 
<span class="p">-(</span><span class="n">NSImage</span> <span class="o">*</span><span class="p">)</span><span class="nf">customImage</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span><span class="o">&amp;</span><span class="n">img_key</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setCustomImage:</span><span class="p">(</span><span class="n">NSImage</span> <span class="o">*</span><span class="p">)</span><span class="nv">image</span> <span class="p">{</span>
    <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span><span class="o">&amp;</span><span class="n">img_key</span><span class="p">,</span><span class="n">image</span><span class="p">,</span>
                             <span class="n">OBJC_ASSOCIATION_RETAIN</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">@end</span></code></pre></td></tr></table>
</div>
</div>
<p>你可以在[runtime.h][11]，（译者注：最新版 [runtime.h][12]）文件中看到向<code>objc_setAssociatedObject()</code>传递的几个选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cm">/* Associative References */</span>

<span class="cm">/**
</span><span class="cm"> * Policies related to associative references.
</span><span class="cm"> * These are options to objc_setAssociatedObject()
</span><span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
    <span class="n">OBJC_ASSOCIATION_ASSIGN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>           <span class="cm">/**&lt; Specifies a weak reference to the associated object. */</span>
    <span class="n">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/**&lt; Specifies a strong reference to the associated object. 
</span><span class="cm">                                            *   The association is not made atomically. */</span>
    <span class="n">OBJC_ASSOCIATION_COPY_NONATOMIC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>   <span class="cm">/**&lt; Specifies that the associated object is copied. 
</span><span class="cm">                                            *   The association is not made atomically. */</span>
    <span class="n">OBJC_ASSOCIATION_RETAIN</span> <span class="o">=</span> <span class="mo">01401</span><span class="p">,</span>       <span class="cm">/**&lt; Specifies a strong reference to the associated object.
</span><span class="cm">                                            *   The association is made atomically. */</span>
    <span class="n">OBJC_ASSOCIATION_COPY</span> <span class="o">=</span> <span class="mo">01403</span>          <span class="cm">/**&lt; Specifies that the associated object is copied.
</span><span class="cm">                                            *   The association is made atomically. */</span>
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
<p>这些和你通过<code>@property</code>方式传递的选项相吻合。</p>

<h4 id="混合的虚表派生">混合的虚表派生</h4>

<p>如果你查看Modern runtime 代码，你会在[objc-runtime-new.m]()（译者注： 最新版objc runtime源码为[objc-runtime-new.mm][14] 已经去掉了这个特性，译者发现从[objc4-551.1][15]版本开始就不支持了，不过读者还是可以借鉴下之前版本的实现方式。）中发现这个：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="cm">/***********************************************************************
</span><span class="cm">* vtable dispatch
</span><span class="cm">* 
</span><span class="cm">* Every class gets a vtable pointer. The vtable is an array of IMPs.
</span><span class="cm">* The selectors represented in the vtable are the same for all classes
</span><span class="cm">*   (i.e. no class has a bigger or smaller vtable).
</span><span class="cm">* Each vtable index has an associated trampoline which dispatches to 
</span><span class="cm">*   the IMP at that index for the receiver class&#39;s vtable (after 
</span><span class="cm">*   checking for NULL). Dispatch fixup uses these trampolines instead 
</span><span class="cm">*   of objc_msgSend.
</span><span class="cm">* Fragility: The vtable size and list of selectors is chosen at launch 
</span><span class="cm">*   time. No compiler-generated code depends on any particular vtable 
</span><span class="cm">*   configuration, or even the use of vtable dispatch at all.
</span><span class="cm">* Memory size: If a class&#39;s vtable is identical to its superclass&#39;s 
</span><span class="cm">*   (i.e. the class overrides none of the vtable selectors), then 
</span><span class="cm">*   the class points directly to its superclass&#39;s vtable. This means 
</span><span class="cm">*   selectors to be included in the vtable should be chosen so they are 
</span><span class="cm">*   (1) frequently called, but (2) not too frequently overridden. In 
</span><span class="cm">*   particular, -dealloc is a bad choice.
</span><span class="cm">* Forwarding: If a class doesn&#39;t implement some vtable selector, that 
</span><span class="cm">*   selector&#39;s IMP is set to objc_msgSend in that class&#39;s vtable.
</span><span class="cm">* +initialize: Each class keeps the default vtable (which always 
</span><span class="cm">*   redirects to objc_msgSend) until its +initialize is completed.
</span><span class="cm">*   Otherwise, the first message to a class could be a vtable dispatch, 
</span><span class="cm">*   and the vtable trampoline doesn&#39;t include +initialize checking.
</span><span class="cm">* Changes: Categories, addMethod, and setImplementation all force vtable 
</span><span class="cm">*   reconstruction for the class and all of its subclasses, if the 
</span><span class="cm">*   vtable selectors are affected.
</span><span class="cm">**********************************************************************/</span></code></pre></td></tr></table>
</div>
</div>
<p>这背后的原理就是，运行时试图去存储你最近调用过的选择子（selector）以便能够为你的App加速，因为其比<code>objc_msgSend</code>方法使用更少的指令。这个<code>vTable</code>存储你最近全局调用的16个选择子，实际上，在代码文件往下接着看你就会看到垃圾回收和非垃圾回收类型的App的默认选择子（selectors）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">defaultVtable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#34;allocWithZone:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;alloc&#34;</span><span class="p">,</span> 
    <span class="s">&#34;class&#34;</span><span class="p">,</span> 
    <span class="s">&#34;self&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isKindOfClass:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;respondsToSelector:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isFlipped&#34;</span><span class="p">,</span> 
    <span class="s">&#34;length&#34;</span><span class="p">,</span> 
    <span class="s">&#34;objectForKey:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;count&#34;</span><span class="p">,</span> 
    <span class="s">&#34;objectAtIndex:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isEqualToString:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isEqual:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;retain&#34;</span><span class="p">,</span> 
    <span class="s">&#34;release&#34;</span><span class="p">,</span> 
    <span class="s">&#34;autorelease&#34;</span><span class="p">,</span> 
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">defaultVtableGC</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#34;allocWithZone:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;alloc&#34;</span><span class="p">,</span> 
    <span class="s">&#34;class&#34;</span><span class="p">,</span> 
    <span class="s">&#34;self&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isKindOfClass:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;respondsToSelector:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isFlipped&#34;</span><span class="p">,</span> 
    <span class="s">&#34;length&#34;</span><span class="p">,</span> 
    <span class="s">&#34;objectForKey:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;count&#34;</span><span class="p">,</span> 
    <span class="s">&#34;objectAtIndex:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isEqualToString:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;isEqual:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;hash&#34;</span><span class="p">,</span> 
    <span class="s">&#34;addObject:&#34;</span><span class="p">,</span> 
    <span class="s">&#34;countByEnumeratingWithState:objects:count:&#34;</span><span class="p">,</span> 
<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="因此你如何能知道你正在和它打交道呢">因此你如何能知道你正在和它打交道呢？</h4>

<p>当你进行调试的时候，你会在你的调试栈中看到稍后讲解到的某些方法的身影。你就把这些方法按照<code>objc_msgSend()</code>方法来对待就行，不过这些方法都是为了调试，具体有如下几个方法。
1.  当运行时正在将你所有调用的这些方法中的其中一个插入到虚表（vTable）中时，会调用<code>objc_msgSend_fixup</code>。</p>

<ol>
<li><p>而当<code>objc_msgSend_fixedup</code>发生时，表明你当前所调用的一个方法本应该存在于虚表中<code>objc_msgSend_vtable[0-15]</code>的位置，但却并不在</p></li>

<li><p>你可能会看到<code>objc_msgSend_vtable5</code>类似的东西，其意味着你正在调用虚表中的一个方法。运行时可以根据需要动态调整虚表中的内容。因此你不应该期望这次代码循环调用的<code>objc_msgSend_vtable10</code>对应了<code>-length</code>方法，而之后每次代码循环还依然会这样。（因为vTable也在不断变化中）</p></li>
</ol>

<p>译者注：参考<a href="http://www.sealiesoftware.com/blog/archive/2011/06/17/objc_explain_objc_msgSend_vtable.html">[objc explain]: objc_msgSend_vtable</a></p>

<h4 id="总结">总结</h4>

<p>我希望你们能够喜欢以上这些东西，这篇文章主要讲述了我和Des Moines Cocoaheads关于Objective-C runtime的谈话（我们的讨论估计能打包一箩筐）。Objective-C Runtime是一项很了不起的工程，它为我们Cocoa/Objective-C下制作的Apps注入能量，使得我们能够实现很多我们认为理所当然的特性。希望你能够看一看Apple官方文档对Objective-C运行时的讲解，这样能够使你更好的利用Objective-C运行时。谢谢。</p>

<h4 id="参考链接">参考链接</h4>

<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Introduction/Introduction.html">Objective-C Runtime Programming Guide</a>
<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/index.html">Objective-C Runtime Reference</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">chen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2015-09-07</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://hechen.xyz/tags/ios/">iOS</a>
          <a href="https://hechen.xyz/tags/objective-c/">Objective-C</a>
          <a href="https://hechen.xyz/tags/runtime/">Runtime</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/objective-c%E4%B8%ADcategory%E7%9A%84%E4%B8%80%E7%82%B9%E4%B8%9C%E8%A5%BF/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Objective-C中Category的一点东西</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/how-we-created-guillotine-menu-animation-for-ios/">
            <span class="next-text nav-default">我们是如何创建iOS版的Guillotine菜单动画的</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://hechen.xyz/post/understanding-the-objective-c-runtime/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'stoneman';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:hechen.dream@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/10229101/chen-he" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/OgreMergO" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/hc2feifei" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>


<a href="https://hechen.xyz/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        chen
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  







  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("wgbxcKzgAuMNE8wvfGp38xwG-gzGzoHsz", "JPVrQwSXVrxiVVsK3WoViro4");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>



  <script id="dsq-count-scr" src="//stoneman.disqus.com/count.js" async></script>





</body>
</html>
