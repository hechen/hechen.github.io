<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>iOS 远端推送部署详解 - I make stuff</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="chen" />
  <meta name="description" content="最近几天被iOS的推送部署给搞懵了，现在特地整理下和大家进行分享。 iOS远端推送机制 APNS，全称为Apple Push Notification service，是苹果通知" />

  <meta name="keywords" content="Chen, iOS, Swift, Productivity" />






<meta name="generator" content="Hugo 0.55.0-DEV" />


<link rel="canonical" href="https://hechen.xyz/post/ios-push-notification/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="iOS 远端推送部署详解" />
<meta property="og:description" content="最近几天被iOS的推送部署给搞懵了，现在特地整理下和大家进行分享。 iOS远端推送机制 APNS，全称为Apple Push Notification service，是苹果通知" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hechen.xyz/post/ios-push-notification/" />
<meta property="article:published_time" content="2015-07-30T14:30:00&#43;00:00"/>
<meta property="article:modified_time" content="2015-07-30T14:30:00&#43;00:00"/>

<meta itemprop="name" content="iOS 远端推送部署详解">
<meta itemprop="description" content="最近几天被iOS的推送部署给搞懵了，现在特地整理下和大家进行分享。 iOS远端推送机制 APNS，全称为Apple Push Notification service，是苹果通知">


<meta itemprop="datePublished" content="2015-07-30T14:30:00&#43;00:00" />
<meta itemprop="dateModified" content="2015-07-30T14:30:00&#43;00:00" />
<meta itemprop="wordCount" content="4573">



<meta itemprop="keywords" content="iOS,Push,Notification," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="iOS 远端推送部署详解"/>
<meta name="twitter:description" content="最近几天被iOS的推送部署给搞懵了，现在特地整理下和大家进行分享。 iOS远端推送机制 APNS，全称为Apple Push Notification service，是苹果通知"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Chen</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Chen
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">iOS 远端推送部署详解</h1>
      
      <div class="post-meta">
        <time datetime="2015-07-30" class="post-time">
          2015-07-30
        </time>
        <div class="post-category">
            <a href="https://hechen.xyz/categories/ios/"> iOS </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#ios远端推送机制">iOS远端推送机制</a></li>
<li><a href="#本地推送证书配置">本地推送证书配置</a>
<ul>
<li><a href="#app-id">APP ID</a></li>
<li><a href="#certificates">Certificates</a></li>
<li><a href="#provisioning-profiles">Provisioning Profiles</a></li>
</ul></li>
<li><a href="#开发环境配置">开发环境配置</a></li>
<li><a href="#远端推送通知的代码实现">远端推送通知的代码实现</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>最近几天被iOS的推送部署给搞懵了，现在特地整理下和大家进行分享。</p>

<h4 id="ios远端推送机制">iOS远端推送机制</h4>

<p>APNS，全称为Apple Push Notification service，是苹果通知推送服务中最重要的一环。它是苹果通知推送服务器，为所有iOS设备以及OS X设备提供强大并且可靠的推送通知服务。每个注册通知服务的设备都会和该服务器进行长连接，从而实时获取推送通知。即使当前APP不在运行状态，当通知到达的时候也会有提示发生，最常见的就是短信服务。</p>

<!-- more -->

<p>每一个App必须向APNs注册通知服务，APNs会返回给设备一个DeviceToken，该Token为APNs上针对该设备的唯一标示符。App需要将该DeviceToken返给自身的Server端保存后续使用，如下所示。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushshare%20the%20device%20Token.png" alt="DeviceToken的操作流程" /></p>

<p>当App开发者的server需要向特定设备推送通知时，就使用DeviceToken和固定格式数据（Push payload）发给APNs，然后APNs就会向DeviceToken指定的设备推送通知了，具体流程如下所示，单一推送
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushPushing%20a%20remote%20notification%20from%20a%20provider%20to%20a%20client%20app.png" alt="通知方推送一条远端通知给客户端代码的整个流程" />
或者多方通知，APNs都能一一对应，靠的就是之前我们提供给它的DeviceToken。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushPushing%20remote%20notifications%20from%20multiple%20providers%20to%20multiple%20devices.png" alt="多个通知方向向不同的客户端推送通知的流程示意" /></p>

<hr />

<h4 id="本地推送证书配置">本地推送证书配置</h4>

<p>打开你mac的钥匙串访问，然后点击钥匙串访问
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush钥匙串.png" alt="打开钥匙串" />
随后它会弹出一个窗口 用户电子邮件信息
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书1.png" alt="生成CSR文件" />
就填写你苹果开发者账号的名称即可（应该是一个邮件名称），点击保存到磁盘的选项，点击继续，点击存储，文件名为：CertificateSigningRequest.certSigningRequest。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书2.png" alt="保存生成的CSR文件" /></p>

<p>然后我们打开<a href="developer.apple.com">苹果开发者中心</a>  进入Member Center
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书3.png" alt="苹果开发者中心" />
然后点击左侧列表中任意一项进入详情页面，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书4.png" alt="开发者个人首页选项" />
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书5.png" alt="选择IOS Apps中列表项" /></p>

<h5 id="app-id">APP ID</h5>

<p>首先我们需要为我们要开发的APP建立身份信息，就是AppID，如图所示，点击左侧
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushAPPID1.png" alt="添加AppID" />
点击添加按钮进入注册页面，我们需要输入App Id的名字以及BundleID，其中BundleID不能有通配符，否则无法具备推送功能，然后在下面的APP Service中勾选Push Notification一项
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushAPPID2.png" alt="填写BundleID以及App ID Description" />
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushAPPID3.png" alt="选择App Service" />
点击下一步，然后确认提交即可，大家注意到Push Notification一项为Configurable，这是因为我们还没有为该AppID生成推送证书，等推送证书生成完毕之后可以再回来查看该AppID 的状态。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书13.jpg" alt="确认提交App ID" /></p>

<h5 id="certificates">Certificates</h5>

<p>其次，我们需要生成开发者证书和推送证书，如下图所示，点击左侧Cerifications列表，选择添加进入下一页面，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书11.png" alt="添加证书" /></p>

<p>如果您的页面如图所示为灰色不可选，说明您已经拥有了开发者证书。就不需要再次生成了，如果可选就选择该选项，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书7.png" alt="选择证书类型" /></p>

<p>接下来进入以下界面，选择你之前添加的AppID，之后点击Continue即可，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书8.png" alt="选择需要绑定证书的App ID" /></p>

<p>然后选择之前我们保存在本地的CSR文件CertificateSigningRequest.certSigningRequest，点击Generate就生成了开发者的证书。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书9.png" alt="上传本机CSR文件" /></p>

<p>同理我们需要生成推送测试证书，生成流程和开发者证书类似，只是在证书类型页面，选择的证书类型换成了Apple Push Notification service SSL。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书10.png" alt="选择生成证书类型" /></p>

<p>当我们生成好推送证书之后再回头看我们之前创建的AppId，能够看Push Notifications一项已经为Enabled了。当然发布推送证书配置完毕之后，Distribution一项也显示为Enable。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书12.jpg" alt="再次查看APPID 状态" /></p>

<h5 id="provisioning-profiles">Provisioning Profiles</h5>

<p>第三步，需要生成Provisioning Profiles，该文件其实就是以上的证书、AppId以及设备信息的打包集合，我们只要在不同的场景下生成不同类型Provisioning Profiles即可，它会在后续打包ipa文件的时候被嵌入安装包内。
首先我们选择左侧列表中的Provisioning Profiles中的All选项，选择添加
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushProvision1.png" alt="添加Provisioning Profiles文件" /></p>

<p>之后选择生成类型，我们这里以开发类型为例，下面还有发布的两种类型，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushProvision2.png" alt="选择生成PP文件类型" /></p>

<p>之后点击Continue，进入下一页面，同样选择我们之前创建的具有Push服务的AppId，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushProvision3.png" alt="选择绑定的App ID" /></p>

<p>接下来，选择上面生成的开发证书（一一对应的，如果你选择生成的是发布Provisioning Profiles，则会出现发布证书），
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushProvision4.png" alt="选择之前生成的对应证书" /></p>

<p>紧接着，我们选择授权设备，即你需要进行开发的设备，该设备可以在左侧Devices列表中添加，需要提供设备的UUID，这里我们选择所有设备，点击Continue，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushProvision5.png" alt="选择授权设备" /></p>

<p>最后一步，我们给Provisioning Profiles添加名称，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushProvision6.png" alt="添加Provisioning Profiles名称" />
点击Generate即生成我们所需要的Provisioning Profile。</p>

<p>其实同理，我们可以生成发布版的开发者证书，推送证书以及对应的Provisioning Profiles。最后的文件我们都放到同一个文件夹里，如图所示，其中我把发布的两种（Ad Hoc 和 Distribution）都一起搞出来。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPush证书200.png" alt="生成的各个证书以及Provisioning Profile文件" /></p>

<p>其中Push.p12文件后续会提及~</p>

<hr />

<h4 id="开发环境配置">开发环境配置</h4>

<p>我们将上一步生成的开发者证书<code>ios_development.cer</code>以及推送证书<code>aps_development.cer</code>在最初生成CSR文件的MAC机上安装，双击即可安装，同时会打开钥匙串页面，安装之后我们找到之前生成CSR文件时生成的专用密钥，名称就是我们之前生成CSR文件时填写的，选择该专用密钥，同时选中刚刚安装成功的推送证书，（<strong>必须注意，同时选择，我们需要将专用密钥以及安装成功的推送证书同时导出成一个文件</strong>）右键菜单导出，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode6.png" alt="导出专用密钥和本地安装的推送证书" />
如图我们命名Push，点击存储，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode7.png" alt="保存到本地" />
接下来需要为证书添加密码，这个密码是需要提供给服务器的。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode8.png" alt="添加证书密码" /></p>

<p>最后我们需要配置我们本地的开发环境，也就是XCode，第一步我们点击XCode的Preference打开XCode的首选项菜单，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode1.png" alt="打开Preference选项" /></p>

<p>在Account选项中添加我们的开发者账户，如果之前已经登录就会看到该账户信息，然后点击下方的View Details，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode5.png" alt="查看账户信息" /></p>

<p>之后会显示该开发者账户的证书和Provisioning Profiles等信息，该信息会和你开发者账号里面显示的一致，如果不一致就点击刷新，
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode3.png" alt="刷新账户信息" /></p>

<p>不久就会出现我们之前创建的Provisioning Profiles，接下来，我们在XCode中Build Settings -&gt; Code Signing中选择我们需要的Provisioning Profiles文件即可
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode4.png" alt="XCode选择对应的Provisioning Profile文件" /></p>

<p>此时本地开发环境已经配置完毕。接下来就开始Coding，Coding，Coding。。。。</p>

<h4 id="远端推送通知的代码实现">远端推送通知的代码实现</h4>

<p>首先我们需要注册推送通知服务并获取DeviceToken；</p>

<pre><code class="language-Objc">- (void)initPushNotificationWithApp: (UIApplication*)application {
    // 注册通知服务
    if([UIDevice currentDevice].systemVersion.floatValue &lt; 8.0) {
        [application registerForRemoteNotificationTypes:(UIRemoteNotificationTypeBadge
                                                       | UIRemoteNotificationTypeSound
                                                       | UIRemoteNotificationTypeAlert)];
    } else {
        // IOS8.0以上版本的注册推送方式和以往不同
        UIUserNotificationSettings* settings = [UIUserNotificationSettings settingsForTypes:(UIRemoteNotificationTypeBadge
                                                                                           | UIRemoteNotificationTypeSound
                                                                                           | UIRemoteNotificationTypeAlert)
                                                                                 categories:nil];
        [application registerUserNotificationSettings:settings];
        [application registerForRemoteNotifications];
    }
}
</code></pre>

<p>如果注册成功，APNs会返回给你设备的token，iOS系统会把它传递给app delegate代理：</p>

<pre><code class="language-Objective-C">// 如果注册成功，则会收到DeviceToken，我们需要将该Token发给服务器保存
- (void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken {
    PRINT_FUNC
    
    NSString* tokenStr = [NSString stringWithFormat:@&quot;%@&quot;, deviceToken];
    NSLog(@&quot;deviceToken: %@&quot;, tokenStr);
    if(tokenStr.length == 0)
    {
        NSLog(@&quot;Device Token Invalid!&quot;);
    }
	
	// 然后我们需要将该DeviceToken发给我们自己的服务器进行保存；
    [self sendDeviceToken:deviceToken]; 
}

// 如果注册失败，会收到错误信息，包含错误原因
- (void)application:(UIApplication *)application didFailToRegisterForRemoteNotificationsWithError:(NSError *)error {
    PRINT_FUNC
    
    NSLog(@&quot;***************************************\n&quot;);
    NSLog(@&quot;Failed to Register The Notification!!!!\n&quot;);
    NSLog(@&quot;error = %@&quot;, error);
    NSLog(@&quot;***************************************\n&quot;);
}
</code></pre>

<p>之后我们就可以在AppDelegate中添加处理代码，当用户点击通知栏的通知或者处于运行状态时，App代码会执行- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo代理方法，如下所示：</p>

<pre><code class="language-Objective-C">- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo {
    PRINT_FUNC
    
    NSLog(@&quot;收到推送通知: %@&quot;, userInfo);
    
    // userInfo是一个字典数据类型，具体Key Value由客户端和服务器进行协商确定
    NSString* orderId = [userInfo objectForKey:@&quot;carryOrderId&quot;];
    NSLog(@&quot;收到订单消息通知，订单号：%@&quot;,orderId);
	
	// .... 其余逻辑，拿到具体关键信息之后进行下一步处理
}
</code></pre>

<p>还有一个方法</p>

<pre><code class="language-Objective-C">/*! This delegate method offers an opportunity for applications with the &quot;remote-notification&quot; background mode to fetch appropriate new data in response to an incoming remote notification. You should call the fetchCompletionHandler as soon as you're finished performing that operation, so the system can accurately estimate its power and data cost.
 
 This method will be invoked even if the application was launched or resumed because of the remote notification. The respective delegate methods will be invoked first. Note that this behavior is in contrast to application:didReceiveRemoteNotification:, which is not called in those cases, and which will not be invoked if this method is implemented. !*/
 
- (void)application:(UIApplication *)application didReceiveRemoteNotification:(NSDictionary *)userInfo fetchCompletionHandler:(void (^)(UIBackgroundFetchResult result))completionHandler; 
</code></pre>

<p>我发现这两个方法在APP处于后台或者前台展示，也就是App存活期会同样调用，但当APP并未启动或者被后台销毁之后，用户点击通知象虽然都会调起App，但是前者这个方法就不会被触发，而后者依然会被触发。注释中也说明了该方法即使在其中或者休眠状态下都会由于远端通知而被调用而且会优先于上一个方法。而且后者可以让你和服务器进行一定的数据交互，比如订单状态变化了，我们在该方法中向服务器请求最新的订单信息等等。</p>

<p>官方文档是这样描述这两个方法的，一目了然：</p>

<pre><code>// Tells the delegate that the running app received a remote notification.
	- application:didReceiveRemoteNotification:

// Tells the app that a remote notification arrived that indicates there is data to be fetched.
	- application:didReceiveRemoteNotification:fetchCompletionHandler:
</code></pre>

<hr />

<p>####服务器端代码实现</p>

<p>Apple官方APNs地址：
1. 测试地址 gateway.sandbox.push.apple.com:2195
2. 正式发布地址 gateway.push.apple.com:2195</p>

<p>简单的通知数据格式，以二进制形式发送，网络字节序。
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushSimple%20Notification%20Format.png" alt="简单的推送通知格式" /></p>

<p>服务器端代码也可以自己使用原生的Socket写，这里我使用Javapns这个开源代码实现，比较简单，Payload数据格式也已经被封装，你只需要add，add，add。代码如下：
其中就需要用到我们之前生成的Push.p12</p>

<pre><code class="language-Java">package testApplePush;

import java.util.List;
import javapns.Push;
import javapns.notification.PushNotificationPayload;
import javapns.notification.PushedNotifications;

public class testApplePush 
{
    public static void main(String[] args)
    {
       try 
       {
          PushNotificationPayload payload = new PushNotificationPayload();

          payload.addAlert(&quot;这是一条推送通知!&quot;); // 通知主体内容
          payload.addBadge(1); // 角标数字
          payload.addSound(&quot;default&quot;); // 通知铃音
          
          // 加入自定义信息
          payload.addCustomDictionary(&quot;carryOrderId&quot;, &quot;121212121212121212121212&quot;);
 
		    // 服务器端记录的DeviceToken
          String deviceToken = &quot;************************************************&quot;;
          PushedNotifications notifications = Push.payload(payload, 	// 自定义payload
												          &quot;Push.p12&quot;,	// 前面生成的证书
												          &quot;111111111&quot;, 	// 证书导出时的密码
												          false,		// 是否发送到发布地址
												          deviceToken); // 客户端DeviceToken

            int numOfFailedNotifications = notifications.getFailedNotifications()
                    .size();
            int numOfSuccessfulNotificatios = notifications
                    .getSuccessfulNotifications().size();

            System.out.println(String.format(
                    &quot;Successful Send: %d, Failed Send: %d&quot;,
                    numOfSuccessfulNotificatios, numOfFailedNotifications));

        } 
        catch (Exception e)
        {
            e.printStackTrace();
        }
    }
}
</code></pre>

<p>当前这里只是发送一条，如果需要批量发送，貌似Javapns支持的不是太好。这里使用的证书就是上面我们导出的.p12格式证书（<strong>Windows平台使用没问题。有些教程说是Win系统不识别是不正确的</strong>），接下来还有一份PHP写的代码，供大家查阅。但是这其中需要将我们的p12格式证书转换成pem格式证书。具体教程如下：
-  将我们之前生成的推送证书aps_developement.cer文件以及Push.p12文件放在同一文件夹下；
-  在Terminal中切换到该目录下，然后执行命令将aps_developement.cer文件转换成pem格式文件，之后会在本目录下生成PushCert.pem文件</p>

<pre><code>openssl x509 -in aps_development.cer -inform der -out PushCert.pem
</code></pre>

<ul>
<li><p>紧接着执行命令将Push.p12文件转换成pem格式文件，之后在本目录下生成PushKey.pem文件，其中会提示你先输入之前生成Push.p12文件的时候的密码，然后需要为新生成的证书文件添加密码，这个密码是要提供给服务端使用的；</p>

<pre><code>openssl pkcs12 -nocerts -out Pushkey.pem -in Push.p12 
</code></pre></li>

<li><p>然后将这两个pem文件合成成一个pem文件，Push.pem</p>

<pre><code>cat PushCert.pem PushKey.pem &gt; Push.pem
</code></pre>

<p>整个过程如下图所示：
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushXCode9.png" alt="pem文件生成过程" /></p></li>
</ul>

<p>证书生成完毕之后，我们就可以在代码中使用了。
如下为PHP写的推送通知服务。代码很简单，主要是注意其中证书为上一步生成的Push.pem，密码就是生成时输入的密码。</p>

<pre><code class="language-PHP">&lt;?php
// DeviceToken 不包含空格
$deviceToken = '********************************************************';
// 证书密码
$passphrase = '1111111111';
// 通知主体内容
$alert = '这是一条推送通知!';

////////////////////////////////////////////////////////////////////////////////
$ctx = stream_context_create();
stream_context_set_option($ctx, 'ssl', 'local_cert', 'Push.pem');		// ck.pem证书上有提及
stream_context_set_option($ctx, 'ssl', 'passphrase', $passphrase);

// Open a connection to the APNS server
$fp = stream_socket_client(
		'ssl://gateway.sandbox.push.apple.com:2195', 			// 远端测试地址
		$err,													
		$errstr, 
		60, 													// 超时时间
		STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT,
		$ctx);
if (!$fp)
	exit(&quot;Failed to connect: $err $errstr&quot; . PHP_EOL);

echo 'Connected to APNS' . PHP_EOL;

// 建立字典数据
$body['aps'] = array(
	'alert' =&gt; $alert,
	'sound' =&gt; 'default',
	'badge' =&gt; 66
	);

// 将字典数据转换成JSON
$payload = json_encode($body);

// 组织二进制数据格式，具体格式参照apple官方文档，本文中也有提及。
// Command + Token length + deviceToken + Payload length + payload
$msg = chr(0) . pack('n', 32) . pack('H*', $deviceToken) . pack('n', strlen($payload)) . $payload;

// 发送组成的数据给APNs
$result = fwrite($fp, $msg, strlen($msg));
if (!$result)
	echo 'Fail to delivery Notification' . PHP_EOL;
else
	echo 'Delivery Notification successfully' . PHP_EOL;

fclose($fp);
?&gt;
</code></pre>

<p>运行下下测试：
<img src="http://7xilk1.com1.z0.glb.clouddn.com/iosPushResult.png" alt="最终测试效果" /></p>

<p>参考：
[1]. <a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Introduction.html#//apple_ref/doc/uid/TP40008194-CH1-SW1">https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Introduction.html#//apple_ref/doc/uid/TP40008194-CH1-SW1</a>
[2]. <a href="https://developer.apple.com/library/prerelease/ios/documentation/UIKit/Reference/UIApplicationDelegate_Protocol/">https://developer.apple.com/library/prerelease/ios/documentation/UIKit/Reference/UIApplicationDelegate_Protocol/</a>
[3]. <a href="http://blog.csdn.net/shenjie12345678/article/details/41120637">http://blog.csdn.net/shenjie12345678/article/details/41120637</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">chen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2015-07-30</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://hechen.xyz/tags/ios/">iOS</a>
          <a href="https://hechen.xyz/tags/push/">Push</a>
          <a href="https://hechen.xyz/tags/notification/">Notification</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/leetcode-018-lengthoflastword/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">[018] Length Of Last Word</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/%E5%85%B3%E4%BA%8E%E5%8D%95%E9%93%BE%E8%A1%A8%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/">
            <span class="next-text nav-default">关于单链表的那些事儿</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:hechen.dream@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/10229101/chen-he" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/OgreMergO" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/hc2feifei" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>


<a href="https://hechen.xyz/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        chen
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
