<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>In App Purchase - I make stuff</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="chen" />
  <meta name="description" content="对于在 App Store 中上架的应⽤来说，应⽤内购买(In-App Purchase，简称 IAP) 应该是一个避不开的话题，尤其是去年微信打赏和 Apple 之间的争执更让 IAP 火" />

  <meta name="keywords" content="Chen, iOS, Swift, Productivity, macOS, Cocoa" />






<meta name="generator" content="Hugo 0.55.3" />


<link rel="canonical" href="https://hechen.xyz/post/in-app-purchase/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="In App Purchase" />
<meta property="og:description" content="对于在 App Store 中上架的应⽤来说，应⽤内购买(In-App Purchase，简称 IAP) 应该是一个避不开的话题，尤其是去年微信打赏和 Apple 之间的争执更让 IAP 火" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hechen.xyz/post/in-app-purchase/" />
<meta property="article:published_time" content="2018-05-24T10:40:39&#43;00:00"/>
<meta property="article:modified_time" content="2018-05-24T10:40:39&#43;00:00"/>

<meta itemprop="name" content="In App Purchase">
<meta itemprop="description" content="对于在 App Store 中上架的应⽤来说，应⽤内购买(In-App Purchase，简称 IAP) 应该是一个避不开的话题，尤其是去年微信打赏和 Apple 之间的争执更让 IAP 火">


<meta itemprop="datePublished" content="2018-05-24T10:40:39&#43;00:00" />
<meta itemprop="dateModified" content="2018-05-24T10:40:39&#43;00:00" />
<meta itemprop="wordCount" content="3223">



<meta itemprop="keywords" content="iOS,IAP,Receipt," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In App Purchase"/>
<meta name="twitter:description" content="对于在 App Store 中上架的应⽤来说，应⽤内购买(In-App Purchase，简称 IAP) 应该是一个避不开的话题，尤其是去年微信打赏和 Apple 之间的争执更让 IAP 火"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Chen</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Chen
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://hechen.xyz/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">In App Purchase</h1>
      
      <div class="post-meta">
        <time datetime="2018-05-24" class="post-time">
          2018-05-24
        </time>
        <div class="post-category">
            <a href="https://hechen.xyz/categories/ios/"> iOS </a>
            
          </div>
        

        
        

        
        
          <span id="/post/in-app-purchase/" class="leancloud_visitors" data-flag-title="In App Purchase">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#in-app-purchase-的整体流程">In App Purchase 的整体流程</a>
<ul>
<li><a href="#阶段-1">阶段 1</a></li>
<li><a href="#阶段-2">阶段 2</a></li>
<li><a href="#阶段-3">阶段 3</a></li>
<li><a href="#注册商品">注册商品</a>
<ul>
<li><a href="#商品类型">商品类型</a></li>
</ul></li>
<li><a href="#获取-product-id">获取 Product ID</a></li>
<li><a href="#获取商品信息">获取商品信息</a></li>
</ul></li>
<li><a href="#展示支付-ui">展示支付 UI</a></li>
<li><a href="#发出购买请求">发出购买请求</a></li>
<li><a href="#处理购买结果">处理购买结果</a></li>
<li><a href="#final-投递商品">Final，投递商品</a></li>
<li><a href="#结束交易">结束交易</a>
<ul>
<li><a href="#关于-transaction-和-receipt-的区别和联系">关于 Transaction 和 Receipt 的区别和联系</a>
<ul>
<li><a href="#关于-transaction">关于 Transaction</a></li>
<li><a href="#关于-receipt">关于 Receipt</a></li>
</ul></li>
</ul></li>
<li><a href="#这里有几个需要注意的点">这里有几个需要注意的点：</a>
<ul>
<li><a href="#恢复已经购买的商品">恢复已经购买的商品</a></li>
</ul></li>
<li><a href="#参考资料">参考资料：</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>对于在 App Store 中上架的应⽤来说，应⽤内购买(In-App Purchase，简称 IAP) 应该是一个避不开的话题，尤其是去年微信打赏和 Apple 之间的争执更让 IAP 火了一把，不仅仅大公司，作为个人开发者来讲，IAP 也是非常重要的，说不定就是你养家糊口的工具呢。</p>

<!-- more -->

<p>整个 IAP 的过程，在客户端的实现依赖于 <code>StoreKit</code> 这个框架，所有的支付相关操作都是交由 StoreKit 来完成的。</p>

<p><img src="https://i.imgur.com/EkBwhM4.png" alt="" /></p>

<p>首先，我们先复习一下 IAP 的整个流程。</p>

<h2 id="in-app-purchase-的整体流程">In App Purchase 的整体流程</h2>

<h3 id="阶段-1">阶段 1</h3>

<p><img src="http://7xilk1.com1.z0.glb.clouddn.com/2018-09-03-4DDE8387-EDB1-42CC-B18C-3DC6CA1DC688.png" alt="In App Purchase 过程" /></p>

<ol>
<li>加载 In-App Identifier</li>
<li>客户端从 AppStore 中获取本地化的商品信息。</li>
<li>把 IAP 的购买界⾯面展示给⽤用户，⽤用户可以同意购买并点击购买按钮。</li>
<li>⽤用户授权购买，客户端向服务器器发送购买请求。</li>
<li>服务器器处理理购买请求，并把结果返回给 <code>StoreKit</code>。</li>
<li>如果购买请求验证通过，客户端此时解锁内容或者提供金币。</li>
<li>至此，整个交易易流程结束。</li>
</ol>

<h3 id="阶段-2">阶段 2</h3>

<p>具体到和 Apple Store 打交道的话，如下所示：</p>

<p><img src="http://7xilk1.com1.z0.glb.clouddn.com/2018-08-27-intro_2x.png" alt="IAP With App Store" /></p>

<h3 id="阶段-3">阶段 3</h3>

<p>如果涉及到自己 App 端 Server 的参与，基本如下图所示：</p>

<p><img src="http://7xilk1.com1.z0.glb.clouddn.com/2018-08-29-1*MwLeHUGSupbb9j-oYQyflw.png" alt="IAP With Business Server" /></p>

<p>正常多出的几步：</p>

<ol>
<li>获取 Product 标识列表；</li>
<li>客户端上传 Receipt 数据给 Server，Server 自行校验或者使用 Apple 的接口校验；</li>
<li>Server 端告知给客户端付费内容</li>
</ol>

<h3 id="注册商品">注册商品</h3>

<p>商品注册是通过 iTunes Connect 后台进行的，其中商品类型需要提前明确好。</p>

<h4 id="商品类型">商品类型</h4>

<p>参与 App 内支付动作的商品有四种类型：</p>

<ul>
<li>Consumable products （消耗型商品）</li>
<li>Non-consumable products （非消耗型商品）</li>
<li>Auto-renewable subscriptions （自动续约订阅）</li>
<li>Non-renewable subscriptions （非自动续约订阅）</li>
</ul>

<p>其中关于非自动续约订阅，App 的开发者有义务同步服务到用户的所有设备上。</p>

<p>如下，是官方文档列出来的四种商品类型的一些主要属性。</p>

<table>
<thead>
<tr>
<th>Product type</th>
<th>Non-consumable</th>
<th>Consumable</th>
<th>Auto-renewable</th>
<th>Non-renewing</th>
</tr>
</thead>

<tbody>
<tr>
<td>Users can buy</td>
<td>Once</td>
<td>Multiple times</td>
<td>Multiple times</td>
<td>Multiple times</td>
</tr>

<tr>
<td>Appears in the receipt</td>
<td>Always</td>
<td>Once</td>
<td>Always</td>
<td>Always</td>
</tr>

<tr>
<td>Synced across devices</td>
<td>By the system</td>
<td>Not synced</td>
<td>By the system</td>
<td>By your app</td>
</tr>

<tr>
<td>Restored</td>
<td>By the system</td>
<td>Not restored</td>
<td>By the system</td>
<td>By your app</td>
</tr>
</tbody>
</table>

<p>其中需要注意的几点：</p>

<ol>
<li>除了非消耗型商品只能买一次，再次购买应该会失败以外，其他三种类型（消耗型，连续/非连续订阅）都是可以无限制购买的，Apple 是不会报错的；</li>
<li>除了消耗型商品在 Receipt 中出现一次，其他三种类型（非消耗型，连续/非连续订阅）是始终都会在其中的，这也是后续做订阅校验至关重要的一环；</li>
</ol>

<h3 id="获取-product-id">获取 Product ID</h3>

<p>这里获取的是 Product 在 iTunes Connect 后台注册商品时填写的 Product ID</p>

<p><img src="http://7xilk1.com1.z0.glb.clouddn.com/2018-09-03-15359854946888.png" alt="Product ID" /></p>

<p>In-App Identifier 为每个可销售的商品提供一个唯一标识。在客户端上，我们可以直接写死代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="kd">let</span> <span class="nv">identifiers</span> <span class="p">=</span> <span class="p">[</span><span class="s">&#34;com.myCompany.myApp.product1&#34;</span><span class="p">,</span> <span class="s">&#34;com.myCompany.myApp.product2&#34;</span> <span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
<p>或者从 Server 端获取。</p>

<h3 id="获取商品信息">获取商品信息</h3>

<p>然后通过上一步取得的 Product ID 来获取具体某个 Product 的详细信息，包括价格，描述等等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="c1">// 获取一批商品的信息</span>

<span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">SKProductsRequest</span><span class="p">(</span><span class="n">productIdentifiers</span><span class="p">:</span> <span class="n">identifierSet</span><span class="p">)</span> 

<span class="n">request</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>

<span class="n">request</span><span class="p">.</span><span class="n">start</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<p>在代理回调中处理获取的结果，进行展示或者 Cache。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="kd">func</span> <span class="nf">productRequest</span><span class="p">(</span><span class="kc">_</span> <span class="n">request</span><span class="p">:</span> <span class="n">SKProductsRequest</span><span class="p">,</span> <span class="n">didReceive</span> <span class="n">response</span><span class="p">:</span> <span class="n">SKProductsResponse</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">for</span> <span class="n">product</span> <span class="k">in</span> <span class="n">response</span><span class="p">.</span><span class="n">products</span> <span class="p">{</span>
    
    <span class="p">}</span> 
<span class="p">}</span> </code></pre></td></tr></table>
</div>
</div>
<p>官方建议是不要进行缓存，因为 Product 的信息有可能会更新，比如用户切换 AppStore 的区域，价格信息也会因为相应的汇率发生变化。不过！在国内，被牺牲最大的用户体验不是这种边界情况，而是获取 Product 信息是需要和 Apple Server 打交道的，这就有个问题 —— 慢！</p>

<p>我们会在开机的时候提前预取所有 Product 信息，并且缓存起来。下次弹出充值面板的时候就直接列出商品信息即可。</p>

<h2 id="展示支付-ui">展示支付 UI</h2>

<p>接下来就看什么时候进行购买了，展示商品面板进行购买。用户在面板上进行选择之后，就进入了下一阶段 ── 支付</p>

<h2 id="发出购买请求">发出购买请求</h2>

<p>这⼀步也很简单， 两⾏行代码就可以搞定。只需要把之前拿到的商品对象传到 <code>SKPayment</code> 的初始化方法中，构造一个 <code>SKPayment</code> 实例，再把这个实例加⼊到购买队列中即可:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="kd">let</span> <span class="nv">payment</span> <span class="p">=</span> <span class="n">SKPayment</span><span class="p">(</span><span class="n">product</span><span class="p">:</span> <span class="n">product</span><span class="p">)</span> <span class="n">SKPaymentQueue</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="n">add</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>之后就交给 Apple 了，此时应用内会弹出苹果设计的购买窗口，用户只要使⽤指纹或者输入密码即可同意付款。</p>

<h2 id="处理购买结果">处理购买结果</h2>

<p>当⽤户的购买请求经过 <code>StoreKit</code> 和苹果服务器的验证后，开发者可以在回调函数中接收到。Apple 具体的回调会通过 <code>SKPaymentQueue</code> 来进行，如下，我们需要在支付之前就向 <code>SKPaymentQueue</code> 中加入代理监听。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="n">SKPaymentQueue</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="n">add</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>你可以把具体的监听放在一个独立的类中完成。在该 Observer 中，实现代理方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="c1">// 处理理 SKPaymentQueueObserver 事件</span>
<span class="c1">// </span><span class="cs">MARK:</span><span class="c1"> - SKPaymentTransactionObserver</span>
<span class="kd">func</span> <span class="nf">paymentQueue</span><span class="p">(</span><span class="kc">_</span> <span class="n">queue</span><span class="p">:</span> <span class="n">SKPaymentQueue</span><span class="p">,</span> <span class="n">updatedTransactions</span> <span class="n">transactions</span><span class="p">:[</span><span class="n">SK</span> <span class="n">PaymentTransaction</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">transaction</span> <span class="k">in</span> <span class="n">transactions</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">transaction</span><span class="p">.</span><span class="n">transactionState</span> <span class="p">{</span> 
            <span class="k">case</span> <span class="p">.</span><span class="n">purchased</span><span class="p">:</span>
            <span class="c1">// Validate the purchase</span>
            
            <span class="c1">// Locate the file</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">appStoreReceiptURL</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// Handle failure</span>
                <span class="k">return</span>    
            <span class="p">}</span>

            <span class="c1">// Read the contents</span>
            <span class="kd">let</span> <span class="nv">receipt</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">contentsOf</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="p">}</span> 
    <span class="p">}</span>
<span class="p">}</span> </code></pre></td></tr></table>
</div>
</div>
<p>对于每一个你提交的 Payment，就一定会有一个相应的 Transaction 生成以便其后续处理。通过检查 transaction 的状态，我们可以指定每种状态下的处理逻辑。如果状态显示已购买， 我们还是应该和⾃己的服务器器进行一次校验，确保交易真实有效⽽而不是通过越狱后的某些插件完成的。被检验的，是一种被苹果称之为收据(receipt)的凭证，就像我们在超市购物或者饭店就餐后拿到的收据一样，每⼀个购买的商品都有⾃己的收据。这个收据由苹果签发，保存在客户端本地。</p>

<p>目前 Apple 官方提供两种方式，一种是本机校验，一种是 Server 端校验。</p>

<p><img src="http://7xilk1.com1.z0.glb.clouddn.com/2018-09-03-E9DC4D03-7F18-49CC-B21D-835904E2B39F.png" alt="Receipt Validation Ways" /></p>

<h2 id="final-投递商品">Final，投递商品</h2>

<p>当 Server 端检验完成之后，说明本地交易已经成功完成，因此将用户购买的内容提供给用户使用。当然，对于业务方，购买完成不代表业务完成，因此大多数情况下还有一步进行商品业务校验的过程。</p>

<p>需要注意的一点是：</p>

<p>Apple 也明确告诉开发者有几个关键的路径节点需要注意：</p>

<p><img src="http://7xilk1.com1.z0.glb.clouddn.com/2018-09-03-C1BB8495-728D-43E7-9C40-8EC9B3A22905.png" alt="关键路径" /></p>

<p>监听交易状态的代码一定要越早越好，比如在 App 完成启动之后进行注册，确保整个生命周期内都有代码逻辑来处理监听到的交易，根据监听到的 Transaction 的状态来分发处理逻辑。因为很有可能你监听的时机太晚，导致 Apple 通知有一些之前未完成的交易的时候你无法捕获。说白了就是用户的购买流程跟 App 生命周期不挂钩导致的，典型的有以下几个场景</p>

<ol>
<li>用户杀死了 App</li>
<li>用户需要更新帐号中的付费信息（此时已跳出 App ）</li>
<li>App 闪退</li>
<li>用户进行了订阅续期</li>
<li>用户进入了推介促销价的流程</li>
<li>用户跳出 App 输入推广码</li>
</ol>

<h2 id="结束交易">结束交易</h2>

<p>在最后一步中，如果是正常的交易，那么简单的结束它们就⾏了。但对于其他异常的交易易，⽐比如出现了一些 error，也要妥善的结束它们。如果是⾃动续期的订阅，也会经过这一步。如果 交易没有被正确的结束，它们会一直停留留在上文提到的队列中，每次回调函数被调用时，队列 中都会有这些没有被结束的交易。也就是为什么需要提前监听的原因了。</p>

<p>结束交易的代码⾮常简单，只有一行:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="n">SKPaymentQueue</span><span class="p">.</span><span class="k">default</span><span class="p">().</span><span class="n">finishTransaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="关于-transaction-和-receipt-的区别和联系">关于 Transaction 和 Receipt 的区别和联系</h3>

<p>很多同学在进行 IAP 开发的时候常常有一个很大的困惑就是 Transaction 和 Receipt 傻傻分不清楚，这里重新梳理了一下。</p>

<h4 id="关于-transaction">关于 Transaction</h4>

<p>其实前面讲 Payment 的操作的时候已经表明了， Transaction 是和具体的一次 Payment 对应的，也就是发生一次 Payment 就会生成 Transaction，但是，并不是 1 对 1 的关系，比如本次 Payment 对应的 Transaction 已经被 finish 了，用户换了手机，登陆同样 AppleID 的时候使用 Restore 功能，Apple 会生成 Transaction 给你，本次的 Transaction 就对应的之前的 Payment，只是状态标记为 .restored。</p>

<p>Transaction 的状态主要有以下这么几种：</p>

<table>
<thead>
<tr>
<th align="left">状态</th>
<th align="left">含义</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">.purchasing</td>
<td align="left">不需要做什么，继续等待 SKPaymentTransactionState 的状态流转</td>
</tr>

<tr>
<td align="left">.purchased</td>
<td align="left">用户已完成付费，处理付费后的流程并调用 finishTransaction 方法</td>
</tr>

<tr>
<td align="left">.failed</td>
<td align="left">用户付费失败，处理付费失败的流程并调用 finishTransaction 方法</td>
</tr>

<tr>
<td align="left">.restored</td>
<td align="left">用户付费成功，处理付费后的流程并调用 finishTransaction 方法</td>
</tr>

<tr>
<td align="left">.deferred</td>
<td align="left">不需要做什么，继续等待 SKPaymentTransactionState 的状态流转</td>
</tr>
</tbody>
</table>

<p><strong>Note</strong>: 对于 <code>finishTransaction</code> 的几点说明：</p>

<ol>
<li>对于那些依赖苹果下载服务的，比如存储在 iTunes Connect 上的付费内容要下载到本地，如果下载完成之前就进行了 finish 动作会导致 Apple 阻断所有的下载流程，并且无法重新下载；</li>
<li>Transaction 需要配合 Receipt 验证是否合法，单纯靠前端是不靠谱的，因此交由业务后端验证 Receipt 更安全合理，业务后端来决定是否需要 finish</li>
<li>文档里说：Your app needs to finish every transaction, regardless of whether the transaction succeeded or failed. 所以我们需要将 Transaction Finish 掉，否则会始终出现在 PaymentQueue 里，BUT，中间态的交易是不需要 finish 的，比如 .purchasing 和 .deferred</li>
</ol>

<h4 id="关于-receipt">关于 Receipt</h4>

<p>Receipt 是 App Store 签发的，是你的 App 上和该 App 上发生的支付行为记录。它存储在设备上的某个固定地址，StoreKit 并不会生成它，它是从 App Store 拉取下来的一个文件。如图所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="k">guard</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">appStoreReceiptURL</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// handle failure</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// read the contents</span>
<span class="kd">let</span> <span class="nv">receipt</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">contentsOf</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>如果本地该地址里没有，我们还可以进行刷新，实质上就是从 App Store 请求 Receipt 数据。请求如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Swift" data-lang="Swift"><span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">SKReceiptRefreshRequest</span><span class="p">()</span>

<span class="n">request</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>

<span class="n">request</span><span class="p">.</span><span class="n">start</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="这里有几个需要注意的点">这里有几个需要注意的点：</h2>

<h3 id="恢复已经购买的商品">恢复已经购买的商品</h3>

<p>这里有一个需要注意的事情就是：如果一个用户试图去购买一个之前购买过的商品，而不是使用你App 提供的 Restore 功能恢复的话，App Store 会依然创建一个正常的新交易。用户是不会被再次收费的，这里的问题是，Transaction 的状态可不是 restored，而是完全新的 Transaction，你可以按照之前的正常流程走，当然对于自带账户体系的 App 来讲，需要自行判断和计算。</p>

<h2 id="参考资料">参考资料：</h2>

<ol>
<li><a href="https://developer.apple.com/in-app-purchase/">In App Purchase</a></li>
<li><a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Introduction.html">In-App Purchase Programming Guide</a></li>
<li><a href="https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Introduction.html">Receipt Validation Programming Guide</a></li>
<li><a href="https://forums.developer.apple.com/thread/46737">How to detect refunded IAPs from receipts?</a></li>
<li><a href="https://stackoverflow.com/questions/10771240/check-if-a-non-renewable-subscription-was-refunded-by-apple">Check if a non-renewable subscription was refunded by Apple?</a></li>
<li><a href="https://stackoverflow.com/questions/6439482/how-does-apple-notify-ios-apps-of-refunds-of-in-app-purchases-iap">How does Apple notify iOS apps of refunds of in-app purchases (IAP)?</a></li>
</ol>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">chen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2018-05-24</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://hechen.xyz/tags/ios/">iOS</a>
          <a href="https://hechen.xyz/tags/iap/">IAP</a>
          <a href="https://hechen.xyz/tags/receipt/">Receipt</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/what-is-llvm/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">What is LLVM</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/dependency-injection-using-factories-in-swift/">
            <span class="next-text nav-default">在 Swift 中使用工厂模式进行依赖注入</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "hechen/Comments"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  <div class="disqus-comment">
  <div class="disqus-button" id="load_disqus" onclick="load_disqus()">
    显示 Disqus 评论
  </div>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_config = function () {
      this.page.url = "https://hechen.xyz/post/in-app-purchase/";
    };
    function load_disqus() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'stoneman';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

      $('#load_disqus').remove();
    };
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  
  </div>
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:hechen.dream@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://stackoverflow.com/users/10229101/chen-he" rel="me noopener" class="iconfont"
      title="stack-overflow"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M809.714286 932.571429l-638.857143 0 0-274.285714-91.428571 0 0 365.714286 821.714286 0 0-365.714286-91.428571 0 0 274.285714zm-538.285714-299.428571l18.857143-89.714286 447.428571 94.285714-18.857143 89.142857zm58.857143-213.714286l38.285714-83.428571 414.285714 193.714286-38.285714 82.857143zm114.857143-203.428571l58.285714-70.285714 350.857143 293.142857-58.285714 70.285714zm226.857143-216l272.571429 366.285714-73.142857 54.857143-272.571429-366.285714zm-410.285714 840.571429l0-90.857143 457.142857 0 0 90.857143-457.142857 0z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/OgreMergO" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/hc2feifei" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>


<a href="https://hechen.xyz/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        chen
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  







  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("wgbxcKzgAuMNE8wvfGp38xwG-gzGzoHsz", "JPVrQwSXVrxiVVsK3WoViro4");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>



  <script id="dsq-count-scr" src="//stoneman.disqus.com/count.js" async></script>





</body>
</html>
